@page "/ai-author"
@inject GeminiService GeminiService
@using MudBlazor
@using BlogApp1.Shared
@layout ReaderLayout
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="py-10 ai-page-root">
    @if (!_showGenerated)
    {
        <!-- ===================== INPUT SECTION ===================== -->
        <MudPaper Class="ai-input-card" Elevation="4">
            <h2 class="ai-title">
                🤖 Generate Your AI Blog
            </h2>

            <MudForm @ref="_form" Class="grid gap-5 md:grid-cols-2">
                <MudTextField Label="Title" @bind-Value="_request.Title" FullWidth="true" Required="true" />

                <MudTextField Label="Audience" @bind-Value="_request.Audience"
                              FullWidth="true" Placeholder="e.g., Developers, Students, Professionals" />

                <MudSelect T="string" Label="Tone" @bind-Value="_request.Tone" FullWidth="true">
                    <MudSelectItem Value="@("Professional")">Professional</MudSelectItem>
                    <MudSelectItem Value="@("Casual")">Casual</MudSelectItem>
                    <MudSelectItem Value="@("Educational")">Educational</MudSelectItem>
                    <MudSelectItem Value="@("Inspirational")">Inspirational</MudSelectItem>
                </MudSelect>

                <MudSelect T="string" Label="Length" @bind-Value="_selectedLength" FullWidth="true">
                    <MudSelectItem Value="@("Short")">Short</MudSelectItem>
                    <MudSelectItem Value="@("Medium")">Medium</MudSelectItem>
                    <MudSelectItem Value="@("Long")">Long</MudSelectItem>
                </MudSelect>

                <MudTextField Label="Custom Prompt (Optional)"
                              @bind-Value="_request.CustomPrompt"
                              Lines="3"
                              Class="md:col-span-2"
                              FullWidth="true"
                              Placeholder="e.g., Include real-world examples, storytelling tone, or add comparisons with 2024 trends." />

                <div class="md:col-span-2 flex justify-between items-center mt-2">
                    <MudSwitch T="bool" @bind-Checked="_request.IncludeImage" Color="Color.Primary">
                        Include Cover Image
                    </MudSwitch>
                </div>

                <div class="md:col-span-2 flex justify-end mt-6">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Class="ai-primary-btn"
                               OnClick="GenerateBlog"
                               Disabled="_isLoading">
                        @(_isLoading ? "Generating..." : "Generate Blog")
                    </MudButton>
                </div>
            </MudForm>
        </MudPaper>

        @if (_isLoading)
        {
            <div class="mt-10 flex flex-col items-center">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                <p class="ai-loading-text">Generating your AI-powered blog... please wait ⏳</p>
            </div>
        }
    }
    else
    {
        @if (state)
        {
            <!-- same input card when state == true -->
            <MudPaper Class="ai-input-card" Elevation="4">
                <h2 class="ai-title">
                    🤖 Generate Your AI Blog
                </h2>

                <MudForm @ref="_form" Class="grid gap-5 md:grid-cols-2">
                    <MudTextField Label="Title" @bind-Value="_request.Title" FullWidth="true" Required="true" />

                    <MudTextField Label="Audience" @bind-Value="_request.Audience"
                                  FullWidth="true" Placeholder="e.g., Developers, Students, Professionals" />

                    <MudSelect T="string" Label="Tone" @bind-Value="_request.Tone" FullWidth="true">
                        <MudSelectItem Value="@("Professional")">Professional</MudSelectItem>
                        <MudSelectItem Value="@("Casual")">Casual</MudSelectItem>
                        <MudSelectItem Value="@("Educational")">Educational</MudSelectItem>
                        <MudSelectItem Value="@("Inspirational")">Inspirational</MudSelectItem>
                    </MudSelect>

                    <MudSelect T="string" Label="Length" @bind-Value="_selectedLength" FullWidth="true">
                        <MudSelectItem Value="@("Short")">Short</MudSelectItem>
                        <MudSelectItem Value="@("Medium")">Medium</MudSelectItem>
                        <MudSelectItem Value="@("Long")">Long</MudSelectItem>
                    </MudSelect>

                    <MudTextField Label="Custom Prompt (Optional)"
                                  @bind-Value="_request.CustomPrompt"
                                  Lines="3"
                                  Class="md:col-span-2"
                                  FullWidth="true"
                                  Placeholder="e.g., Include real-world examples, storytelling tone, or add comparisons with 2024 trends." />

                    <div class="md:col-span-2 flex justify-between items-center mt-2">
                        <MudSwitch T="bool" @bind-Checked="_request.IncludeImage" Color="Color.Primary">
                            Include Cover Image
                        </MudSwitch>
                    </div>

                    <div class="md:col-span-2 flex justify-end mt-6">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Class="ai-primary-btn"
                                   OnClick="GenerateBlog"
                                   Disabled="_isLoading">
                            @(_isLoading ? "Generating..." : "Generate Blog")
                        </MudButton>
                    </div>
                </MudForm>
            </MudPaper>
        }
        else
        {
            <MudContainer Style="margin-bottom:20px;">

                <MudGrid Spacing="5">
                    <MudItem md="12">
                        <MudContainer Class="ai-header-strip">

                            <MudGrid>
                                <MudItem md="1">
                                    <MudContainer Class="ai-center">
                                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Default"
                                                       OnClick="changeState" Title="Back to Dashboard" />
                                    </MudContainer>
                                </MudItem>
                                <MudItem xs="12" sm="11">
                                    <MudTextField @bind-Value="_blog.Title"
                                                  Style="font-family:'Satoshi', system-ui, sans-serif;font-weight:600"
                                                  Typo="Typo.h3"
                                                  Placeholder="Edit Blog Title"
                                                  Variant="Variant.Text"
                                                  AutoGrow
                                                  FullWidth="true" />
                                </MudItem>
                                <MudItem xs="12" sm="12">
                                    <MudStack Row="true">
                                        <MudHidden Breakpoint="Breakpoint.SmAndDown">
                                            <MudText Typo="Typo.subtitle1" Class="mx-4">
                                                <strong>Reading Time:</strong> @(_blog?.Estimated_Read_Time) min
                                            </MudText>
                                        </MudHidden>
                                        <MudSpacer />
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudContainer>
                    </MudItem>

                    <!-- Content editor -->
                    <MudItem xs="12" md="7">
                        <MudPaper Class="ai-content-card" Elevation="4">
                            <MudTextField Label="Content (HTML)"
                                          @bind-Value="_blog.Content"
                                          Lines="27"
                                          FullWidth="true"
                                          Class="mb-4 font-mono text-sm" />
                        </MudPaper>
                    </MudItem>

                    <!-- SEO / meta -->
                    <MudItem xs="12" md="5">
                        <MudPaper Class="ai-meta-card" Elevation="4">
                            <MudStack Style="padding:0">
                                <MudContainer Class="ai-cover-container">
                                    <MudImage Src="@_blog.Image_Url"
                                              Class="ai-cover-image" />
                                </MudContainer>

                                <MudGrid Spacing="2">
                                    <MudItem md="12">
                                        <MudTextField T="string"
                                                      class="mb-4"
                                                      @bind-Text="_blog.Slug"
                                                      Label="Slug"
                                                      Placeholder="Slug For SEO"
                                                      Variant="Variant.Outlined"
                                                      AutoGrow />
                                        <MudTextField Label="Meta Description"
                                                      @bind-Value="_blog.Meta_Description"
                                                      Variant="Variant.Outlined"
                                                      FullWidth="true"
                                                      Lines="2"
                                                      Class="mb-4" />
                                    </MudItem>

                                    <MudItem md="12">
                                        <MudTextField Label="Category"
                                                      @bind-Value="_blog.Category"
                                                      Variant="Variant.Outlined"
                                                      FullWidth="true"
                                                      Class="mb-4" />
                                    </MudItem>

                                    <MudItem md="12">
                                        @foreach (var c in _blog.Tags)
                                        {
                                            <MudChip T="string"
                                                     Class="ai-tag-chip m-1"
                                                     Color="Color.Dark"
                                                     Variant="Variant.Outlined">
                                                @c
                                            </MudChip>
                                        }
                                    </MudItem>
                                </MudGrid>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem md="12">
                        <MudPaper Class="ai-actions-card" Elevation="4">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Class="ai-primary-btn"
                                       OnClick="SaveBlog">
                                💾 Save Blog
                            </MudButton>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

            </MudContainer>

            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="changeState">
                change
            </MudButton>
        }
    }
</MudContainer>

@code {
    private MudForm _form;
    private GeminiRequest _request = new();
    private GeminiBlogOutput? _blog;
    private bool _isLoading = false;
    private bool _showGenerated = false;
    private string _selectedLength = "";
    private bool state = false;
    private string Content = "";

    private async Task GenerateBlog()
    {
        await _form.Validate();
        _isLoading = true;
        _showGenerated = false;
        StateHasChanged();

        _request.Length = _selectedLength switch
        {
            "Short" => "Short (300-500 words)",
            "Medium" => "Medium (600-900 words)",
            "Long" => "Long (1000+ words)",
            _ => "Medium (600-900 words)"
        };

        var result = await GeminiService.GenerateBlogAsync(_request);
        _blog = result;
        Content = _blog.Content;
        if (_blog != null)
        {
            if (string.IsNullOrWhiteSpace(_blog.Image_Url))
                _blog.Image_Url = $"https://picsum.photos/seed/{Uri.EscapeDataString(_blog.Category ?? _request.Title)}/1200/600";
        }

        _isLoading = false;
        _showGenerated = true;
        StateHasChanged();
    }

    void changeState()
    {
        state = !state;
    }

    private void GoBack()
    {
        _showGenerated = false;
        _blog = null;
        StateHasChanged();
    }

    private async Task SaveBlog()
    {
        var aiBlog = new AIBlogDto
        {
            Title = _blog.Title,
            Slug = _blog.Slug,
            Content = _blog.Content,
            MetaDescription = _blog.Meta_Description,
            Category = _blog.Category,
            Tags = _blog.Tags?.ToList() ?? new List<string>(),
            CoverImageUrl = _blog.Image_Url,
            ReadingTime = _blog.Estimated_Read_Time
        };

        var (success, message) = await GeminiService.SaveAIBlogAsync(aiBlog);

        if (success)
            Snackbar.Add($"✅ {message}", Severity.Success);
        else
            Snackbar.Add($"❌ {message}", Severity.Error);
    }
}

<style>
    .ai-page-root {
        background: #FBFAFF;
    }

    .ai-input-card {
        padding: 24px;
        border-radius: 20px;
        background: linear-gradient(135deg, #C7D2FE, #E9D5FF);
        border: 1px solid rgba(61, 56, 122, 0.16);
    }

    .ai-title {
        font-size: 1.6rem;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
        color: #2f2a63;
        font-family: 'Poppins', 'Segoe UI', sans-serif;
    }

    .ai-loading-text {
        margin-top: 12px;
        color: #4b5563;
        font-size: 0.95rem;
    }

    .ai-primary-btn {
        border-radius: 999px;
        padding-inline: 22px;
        background: linear-gradient(135deg, #3d387a, #E9D5FF);
        color: #ffffff;
    }

    .ai-header-strip {
        padding: 12px 16px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ede9fe, #e0e7ff);
        border: 1px solid rgba(61, 56, 122, 0.18);
        margin-bottom: 12px;
    }

    .ai-center {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .ai-content-card {
        border-radius: 12px;
        padding: 12px;
        height: 100%;
        background-color: #EDE9FE;
        border: 1px solid rgba(61, 56, 122, 0.18);
    }

    .ai-meta-card {
        border-radius: 12px;
        padding: 12px;
        background-color: #EDE9FE;
        border: 1px solid rgba(61, 56, 122, 0.18);
    }

    .ai-cover-container {
        height: 240px;
        padding: 0;
        margin-bottom: 10px;
    }

    .ai-cover-image {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        object-fit: cover;
        box-shadow: 0 4px 12px rgba(61, 56, 122, 0.25);
    }

    .ai-tag-chip {
        border-radius: 999px;
        border-color: rgba(61, 56, 122, 0.4);
        color: #3d387a;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .ai-actions-card {
        padding: 10px 16px;
        background-color: #ffffff;
        border-radius: 12px;
        border: 1px solid #3d387a;
        display: flex;
        gap: 12px;
    }
</style>
