@page "/author/library"
@layout ReaderLayout
@using BSService.Services
@using BlogApp1.Shared
@using BlogApp1.Client.Services
@inject BlogService BSService
@inject CommentService CommentService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="allblogs-container">
    <MudPaper Elevation="8" Class="allblogs-shell">
        <!-- Header -->
        <div class="allblogs-header">
            <div>
                <MudText Typo="Typo.h4" Class="allblogs-title">
                    My Library

                </MudText>
                <MudText Typo="Typo.body2" Class="allblogs-subtitle">
                    Your personal collection of reads and interactions.

                </MudText>
            </div>
        </div>

        <!-- Search + Filters -->
        <div class="allblogs-filters">
            <MudTextField T="string" @bind-Value="searchQuery"
                          Placeholder="Search by title or author..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="allblogs-search"
                          Immediate="true"
                          DebounceInterval="250"
                          SearchFunc="SearchSuggestions"
                          Clearable="true" />



            <MudSelect T="string" @bind-Value="selectedCategoryFilter"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Label="Domain"
                       Class="allblogs-filter-select">
                <MudSelectItem Value="@("All")">All</MudSelectItem>
                <MudSelectItem Value="@("Machine Learning")">Machine Learning</MudSelectItem>
                <MudSelectItem Value="@("Artificial Intelligence")">Artificial Intelligence</MudSelectItem>
                <MudSelectItem Value="@("Lifestyle")">Lifestyle</MudSelectItem>
                <MudSelectItem Value="@("Travel")">Travel</MudSelectItem>
                <MudSelectItem Value="@("Education")">Education</MudSelectItem>
                <MudSelectItem Value="@("Food")">Food</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" @bind-Value="selectedSort"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Label="Sort"
                       Class="allblogs-filter-select">
                <MudSelectItem Value="@("Latest")">Latest</MudSelectItem>
                <MudSelectItem Value="@("Oldest")">Oldest</MudSelectItem>
                <MudSelectItem Value="@("MostViewed")">Most Viewed</MudSelectItem>
                <MudSelectItem Value="@("MostLiked")">Most Liked</MudSelectItem>
            </MudSelect>
            <MudSpacer />

            <MudToggleIconButton @bind-Toggled="isGridView" Icon="@Icons.Material.Filled.GridView" ToggledIcon="@Icons.Material.Filled.List" Color="Color.Primary" ToggledColor="@Color.Success" />
        </div>
        <MudStack Spacing="2" Class="mb-3">
            <MudChipSet T="string"
                        @bind-SelectedValue="_activeSection"
                        CheckMark="false"
                        MultiSelection="false"
                        Mandatory="true"
                        SelectedColor="Color.Primary"
                        Variant="Variant.Outlined"
                        Class="section-chipset">

                <MudChip Value="@("Saved")" Color="Color.Default" Class="section-chip">Saved</MudChip>
                <MudChip Value="@("Liked")" Color="Color.Default" Class="section-chip">Liked</MudChip>
                <MudChip Value="@("History")" Color="Color.Default" Class="section-chip">History</MudChip>
                <MudChip Value="@("Comments")" Color="Color.Default" Class="section-chip">Comments</MudChip>
            </MudChipSet>

            <style>
                .section-chipset {
                    gap: 8px;
                }

                .section-chip {
                    border-radius: 999px;
                    padding-inline: 14px;
                    text-transform: none;
                }

                /* Selected chip visual (relies on SelectedColor + Outlined) */
                .mud-chip.mud-chip-selected.section-chip {
                    border-color: 1px solid #3d387a;
                    color: #3d387a;
                }
            </style>

            @if (_activeSection == "Saved")
            {
                @SavedTab()
            }
            else if (_activeSection == "Liked")
            {
                @LikedTab()
            }
            else if (_activeSection == "History")
            {
                @HistoryTab()
            }
            else if (_activeSection == "Comments")
            {
                <MudStack Spacing="3" Class="mt-2">
                    @if (Comments == null)
                    {
                        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                    }
                    else if (Comments.Count == 0)
                    {
                        <MudContainer Class="pa-6 d-flex flex-column align-center" Style="background-color:transparent" Elevation="0">
                            <MudText Typo="Typo.h6">No comments found</MudText>
                            <MudText Typo="Typo.body2" Class="mb-3">Trying leaving some comments to engage with people</MudText>
                        </MudContainer>
                    }
                    else
                    {
                        <MudGrid>
                            @foreach (var comment in Comments)
                            {
                                <MudItem xs="12" sm="6" md="6">
                                    <MudPaper Class="pa-2 mb-3" Elevation="4" Style="background: rgba(193, 188, 214,0.3);;height:100%;">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                            <MudAvatar Style="height:35px; width:35px; font-size:1rem;background-color:#3f51b5;color:white;">@comment.AuthorName.First()</MudAvatar>
                                            <MudStack Spacing="0">
                                                <MudText Style="padding:0;" Typo="Typo.caption">@comment.AuthorName</MudText>
                                                <MudText Style="padding:0;color:grey;" Typo="Typo.caption">@comment.CreatedAt?.Date.ToString("MMM dd")</MudText>
                                            </MudStack>
                                            <MudSpacer />
                                            <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Color="Color.Primary" />
                                        </MudStack>
                                        <MudText Typo="Typo.h6" Style="color:#212121;cursor:pointer;font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;font-weight:500;" Class="mt-3">@comment.Content</MudText>
                                        <MudText Typo="Typo.subtitle2">
                                            @comment.BlogTitle
                                        </MudText>
                                        <MudStack Row="true" Class="mt-2">
                                            <MudStack Row="true">
                                                <MudText Typo="Typo.body2" Style="color:darkgrey">
                                                    @foreach (var AuthorName in CommentAuthors)
                                                    {
                                                        @if (AuthorName.Commentuid == comment.CommentUid)
                                                        {
                                                            @($"Replying to {AuthorName.Name}")
                                                        }
                                                    }
                                                </MudText>
                                            </MudStack>
                                            <MudSpacer />

                                        </MudStack>
                                    </MudPaper>
                                    <MudDivider />
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudStack>

            }
        </MudStack>
    </MudPaper>


</MudContainer>


@code {

    private bool isGridView { get; set; } = true;
    private string searchQuery { get; set; } = "";
    private string selectedSort { get; set; } = "Latest";
    private string selectedCategoryFilter { get; set; } = "All";
    private string _activeSection = "Saved";
    public SelectionMode SelectionMode = SelectionMode.SingleSelection;
    private List<BlogDto>? Blogs = new();
    private List<int> LikedIds = new();
    private List<int> HistoryIds = new();
    private List<int> SavedIds = new();
    private List<CollectionResponse> Collections = new();
    private List<CommentDto> Comments = new();
    private List<AuthorComment> CommentAuthors = new();
    public class AuthorComment
    {
        public string Name { get; set; }
        public Guid Commentuid { get; set; }
    }
    protected override async Task OnInitializedAsync()
    {
        Blogs = await BSService.GetAllBlogsAsync();
        SavedIds = await BSService.GetSavedIdAsync();
        LikedIds = await BSService.GetLikedIdAsync();
        HistoryIds = await BSService.GetReadingHistoryAsync();
        Comments = await CommentService.GetCommentsByUserAsync();
        foreach (var comment in Comments)
        {
            if (comment.ParentCommentUid.HasValue)
            {
                var AuthorName = await CommentService.GetAuthorName(comment.ParentCommentUid);
                CommentAuthors.Add(new AuthorComment { Name = AuthorName, Commentuid = comment.CommentUid });
            }
            else
            {
                var AuthorName = await CommentService.GetAuthorUsingId(comment.BlogId);
                CommentAuthors.Add(new AuthorComment { Name = AuthorName, Commentuid = comment.CommentUid });
            }
        }
        foreach (var c in CommentAuthors)
        {
            Console.WriteLine($"{c.Name}");
        }
        foreach (var comment in Comments)
        {
            comment.BlogTitle = await CommentService.GetTitleAsync(comment.BlogId);
        }

    }
    private IEnumerable<BlogDto> SavedBlogs => FilterAndSort(Blogs.Where(b => SavedIds.Contains(b.Id)));
    private IEnumerable<BlogDto> LikedBlogs => FilterAndSort(Blogs.Where(b => LikedIds.Contains(b.Id)));
    private IEnumerable<BlogDto> HistoryBlogs => FilterAndSort(Blogs.Where(b => HistoryIds.Contains(b.Id)));


    private IEnumerable<BlogDto> FilterAndSort(IEnumerable<BlogDto> list)
    {
        var q = list;

        if (!string.IsNullOrWhiteSpace(searchQuery))
            q = q.Where(b => b.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                             b.AuthorName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));

        if (selectedCategoryFilter != "All")
            q = q.Where(b => b.Domain == selectedCategoryFilter);

        q = selectedSort switch
        {
            "Oldest" => q.OrderBy(b => b.CreatedAt),
            "MostViewed" => q.OrderByDescending(b => b.ViewCount),
            "MostLiked" => q.OrderByDescending(b => b.LikesCount),
            _ => q.OrderByDescending(b => b.CreatedAt),
        };

        return q;
    }

    private async Task ToggleLike(int blogId, bool isChecked)
    {
        if (isChecked)
        {
            if (!LikedIds.Contains(blogId))
            {
                LikedIds.Add(blogId);
                foreach (var blog in Blogs)
                {
                    if (blog.Id == blogId)
                    {
                        blog.LikesCount += 1;
                    }
                }
                var success = await BSService.ToggleLikeAsync(blogId, true);
                if (!success)
                {
                    LikedIds.Remove(blogId);
                }
            }
        }
        else
        {
            if (LikedIds.Contains(blogId))
            {
                LikedIds.Remove(blogId);
                foreach (var blog in Blogs)
                {
                    if (blog.Id == blogId)
                    {
                        blog.LikesCount -= 1;
                    }
                }
                var success = await BSService.ToggleLikeAsync(blogId, false);
                if (!success)
                {
                    LikedIds.Add(blogId);
                }

            }
        }
    }
    private async Task ToggleSave(int blogId, bool isChecked)
    {
        if (isChecked)
        {
            if (!SavedIds.Contains(blogId))
            {
                SavedIds.Add(blogId);
                var success = await BSService.ToggleSaveAsync(blogId, true);
                if (!success)
                {
                    SavedIds.Remove(blogId);
                }
            }
        }
        else
        {
            if (SavedIds.Contains(blogId))
            {
                SavedIds.Remove(blogId);
                var success = await BSService.ToggleSaveAsync(blogId, false);
                if (!success)
                {
                    SavedIds.Add(blogId);
                }

            }
        }
    }

    private void RemoveFromHistory(int blogId)
    {
        HistoryIds.Remove(blogId);
    }

    private void ClearHistory()
    {
        HistoryIds.Clear();
    }
    private void NavigateToExplorer()
    {
        NavigationManager.NavigateTo("reader/search");
    }
    private void CreateNewCollection()
    {
        var newId = Collections.Any() ? (Collections.Count + 1) : 1;
        Collections.Add(new CollectionResponse { Id = Guid.NewGuid(), CollectionName = $"New Collection {newId}", Description = "Newly created collection" });
    }

    private void AddToCollection(int blogId, Guid collectionId)
    {
        var c = Collections.FirstOrDefault(x => x.Id == collectionId);
        if (c != null && !c.BlogIds.Contains(blogId)) c.BlogIds.Append(blogId);
    }

    private void RemoveFromCollection(int blogId, Guid collectionId)
    {
        var c = Collections.FirstOrDefault(x => x.Id == collectionId);
        var ids = c?.BlogIds.ToList();
        ids.Remove(blogId);
        c.BlogIds = ids.ToArray();
    }
    private async Task GoToBlog(string slug, int BlogId)
    {
        NavigationManager.NavigateTo($"/author/blog/{slug}");
        await BSService.TrackReadAsync(BlogId);
    }
    private async Task SharePost(BlogDto blog)
    {
        if (blog == null) return;

        var title = blog.Title;
        var text = blog?.Content.Substring(0, 50);
        var url = $"https://myblog.com/blog/{blog.Slug}";

        await JS.InvokeVoidAsync("navigator.share", new
        {
            title,
            text,
            url
        });
    }


    //saved code logic
    RenderFragment SavedTab() => @<div>
@if (!SavedBlogs.Any())
    {
    <MudContainer Class="pa-6 d-flex flex-column align-center" Style="background-color:transparent" Elevation="0">
        <MudText Typo="Typo.h6">No saved blogs found</MudText>
        <MudText Typo="Typo.body2" Class="mb-3">Save articles while exploring to build your library.</MudText>
    </MudContainer>
    }
    else
    {
@if (isGridView)
    {
    <MudGrid Class="mt-3">
        @foreach (var b in SavedBlogs)
                {
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Class="pa-2 mb-3" Elevation="4" Style="background: rgba(193, 188, 214,0.3);;height:100%;">
                <MudContainer Style="min-height:280px;margin:0;padding:0;">
                    <img src="@b.CoverImageUrl" alt="@b.Title" style="width:100%;height:140px;object-fit:cover;border-radius:4px" />
                    <MudText Typo="Typo.subtitle1" Class="mt-2 font-bold cursor-pointer" Style="color:#004d40" @onclick="@(() => GoToBlog(b.Slug, b.Id))">@b.Title</MudText>
                    <MudText Typo="Typo.caption">@b.AuthorName • @b.CreatedAt?.ToString("MMM dd, yyyy")</MudText>
                    <MudText Typo="Typo.body2" Class="mt-1">@b.Content.Substring(3, 50)...</MudText>
                </MudContainer>

                <div class="d-flex align-center mt-2">
                    <MudCheckBox T="bool" Value="@LikedIds.Contains(b.Id)" ValueChanged="@(checkedValue => ToggleLike(b.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder" Class="like-button-css ml-3"></MudCheckBox>
                    <MudCheckBox T="bool" Value="@SavedIds.Contains(b.Id)" ValueChanged="@(checkedValue => ToggleSave(b.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Bookmark" UncheckedIcon="@Icons.Material.Filled.BookmarkBorder" Style="padding-top:3px;" Class="like-button-css save-css ml-2"></MudCheckBox>
                    <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" @onclick="@(() => SharePost(b))" Class="share-css ml-2" />
                    <MudSpacer />
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => GoToBlog(b.Slug, b.Id))">Read</MudButton>
                </div>
            </MudPaper>
        </MudItem>
                }
    </MudGrid>
    }
    else
{
        <MudGrid>
            @foreach (var blog in SavedBlogs)
            {
                <MudItem xs="12" md="6">
                    <MudContainer Style="margin-top:10px;margin-bottom:10px;padding:0;" Elevation="3">
                        <MudGrid>
                            @* content *@
                            <MudItem sm="9" md="8">
                                <MudContainer Style="margin:0;padding:0;min-height:230px;">
                                    <MudContainer Style="padding:10px;">
                                        <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                            <MudAvatar Size="Size.Small" Style="background-color:#3f51b5;color:white;">@(blog.AuthorName.First())</MudAvatar>
                                            <MudText Typo="Typo.caption" Style="padding-top:3px;">@blog.AuthorName</MudText>
                                        </MudStack>
                                        <MudText Typo="Typo.h5" Style="color:#212121;cursor:pointer;font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;font-weight:800;" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))" Class="mt-3">@blog.Title</MudText>
                                        <MudText Typo="Typo.body1" Truncate="true" style="color:#757575">
                                            @((blog.Content?.Length > 150) ? blog.Content.Substring(3, 100) + "..." : blog.Content.Substring(3, blog.Content.Length - 3))
                                        </MudText>
                                    </MudContainer>
                                </MudContainer>
                                <MudContainer Style="display:flex;justify-content:start;padding-left:10px;width:100%">
                                    <MudStack Row="true">
                                        <MudStack Row="true" Spacing="0" Style="padding-top:3px">
                                            <MudText Typo="Typo.caption" Style="color:#312121">@blog.CreatedAt?.Date.ToString("MMM dd")</MudText>
                                            <MudCheckBox T="bool" Value="@LikedIds.Contains(blog.Id)" ValueChanged="@(checkedValue => ToggleLike(blog.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder" Class="like-button-css ml-3"></MudCheckBox>
                                            <MudText Typo="Typo.caption" Style="color:#312121;" Class="ml-1">@blog.LikesCount</MudText>
                                            <MudIconButton Icon="@Icons.Material.Filled.Comment" Size="Size.Small" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))" Class="share-css ml-3" />
                                            <MudText Typo="Typo.caption" Style="color:#312121;" Class="ml-1"></MudText>
                                        </MudStack>
                                    </MudStack>
                                    <MudSpacer />
                                    <MudStack Row="true">
                                        <MudStack Row="true" Spacing="0">
                                            <MudCheckBox T="bool" Value="@SavedIds.Contains(blog.Id)" ValueChanged="@(checkedValue => ToggleSave(blog.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Bookmark" UncheckedIcon="@Icons.Material.Filled.BookmarkBorder" Style="padding-top:3px;" Class="like-button-css save-css ml-2"></MudCheckBox>
                                            <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" @onclick="@(() => SharePost(blog))" Class="share-css ml-2" />

                                            <MudMenu Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" Class="share-css ml-2">
                                                <MudContainer Style="height:100%;width:220px;padding:0;">
                                                    <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Not Interested</MudText>
                                                    <MudDivider></MudDivider>
                                                    <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Follow author</MudText>
                                                    <MudDivider></MudDivider>
                                                    <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Mute author</MudText>
                                                    <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;padding-top:0;;color:rgb(170,0,0)">Report story...</MudText>
                                                </MudContainer>
                                            </MudMenu>

                                        </MudStack>
                                    </MudStack>
                                </MudContainer>
                            </MudItem>
                            <MudItem sm="3" md="4">
                                <MudContainer style="display:flex;justify-content:center;align-items:center;width:100%;height:100%;padding:0;cursor:pointer;" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))">
                                    <MudImage Src="@blog.CoverImageUrl" Alt="@blog.Title" Style="width:100%;height:100%;padding-top:50px;padding-bottom:40px;padding-right:20px;" />
                                </MudContainer>
                            </MudItem>
                        </MudGrid>
                    </MudContainer>
                    <MudDivider />
                </MudItem>
            }
        </MudGrid>
}
    }
</div>;




    //liked code logic

                 RenderFragment LikedTab() => @<div>
@if (!LikedBlogs.Any())
{
        <MudContainer Class="pa-6 d-flex flex-column align-center" Style="background-color:transparent" Elevation="0">
            <MudText Typo="Typo.h6">No Liked blogs found</MudText>
            <MudText Typo="Typo.body2" Class="mb-3">Tap the heart on articles you enjoy — they'll show up here.</MudText>
        </MudContainer>
}
else
{
    @if (isGridView)
    {
            <MudGrid Class="mt-3">
                @foreach (var b in LikedBlogs)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudPaper Class="pa-2 mb-3" Elevation="4" Style="background: rgba(193, 188, 214,0.3);;height:100%;">
                            <MudContainer Style="min-height:280px;margin:0;padding:0;">
                                <img src="@b.CoverImageUrl" alt="@b.Title" style="width:100%;height:140px;object-fit:cover;border-radius:4px" />
                                <MudText Typo="Typo.subtitle1" Class="mt-2 font-bold cursor-pointer" Style="color:#004d40" @onclick="@(() => GoToBlog(b.Slug, b.Id))">@b.Title</MudText>
                                <MudText Typo="Typo.caption">@b.AuthorName • @b.CreatedAt?.ToString("MMM dd, yyyy")</MudText>
                                <MudText Typo="Typo.body2" Class="mt-1">@b.Content.Substring(3, 50)...</MudText>
                            </MudContainer>

                            <div class="d-flex align-center mt-2">
                                <MudCheckBox T="bool" Value="@LikedIds.Contains(b.Id)" ValueChanged="@(checkedValue => ToggleLike(b.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder" Class="like-button-css ml-3"></MudCheckBox>
                                <MudCheckBox T="bool" Value="@SavedIds.Contains(b.Id)" ValueChanged="@(checkedValue => ToggleSave(b.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Bookmark" UncheckedIcon="@Icons.Material.Filled.BookmarkBorder" Style="padding-top:3px;" Class="like-button-css save-css ml-2"></MudCheckBox>
                                <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" @onclick="@(() => SharePost(b))" Class="share-css ml-2" />
                                <MudSpacer />
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => GoToBlog(b.Slug, b.Id))">Read</MudButton>
                            </div>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
    }
    else
    {
            <MudGrid>
                @foreach (var blog in LikedBlogs)
                {
                    <MudItem xs="12" md="6">
                        <MudContainer Style="margin-top:10px;margin-bottom:10px;padding:0;" Elevation="3">
                            <MudGrid>
                                @* content *@
                                <MudItem sm="9" md="8">
                                    <MudContainer Style="margin:0;padding:0;min-height:230px;">
                                        <MudContainer Style="padding:10px;">
                                            <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                <MudAvatar Size="Size.Small" Style="background-color:#3f51b5;color:white;">@(blog.AuthorName.First())</MudAvatar>
                                                <MudText Typo="Typo.caption" Style="padding-top:3px;">@blog.AuthorName</MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.h5" Style="color:#212121;cursor:pointer;font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;font-weight:800;" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))" Class="mt-3">@blog.Title</MudText>
                                            <MudText Typo="Typo.body1" Truncate="true" style="color:#757575">
                                                @((blog.Content?.Length > 150) ? blog.Content.Substring(3, 100) + "..." : blog.Content.Substring(3, blog.Content.Length - 3))
                                            </MudText>
                                        </MudContainer>
                                    </MudContainer>
                                    <MudContainer Style="display:flex;justify-content:start;padding-left:10px;width:100%">
                                        <MudStack Row="true">
                                            <MudStack Row="true" Spacing="0" Style="padding-top:3px">
                                                <MudText Typo="Typo.caption" Style="color:#312121">@blog.CreatedAt?.Date.ToString("MMM dd")</MudText>
                                                <MudCheckBox T="bool" Value="@LikedIds.Contains(blog.Id)" ValueChanged="@(checkedValue => ToggleLike(blog.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder" Class="like-button-css ml-3"></MudCheckBox>
                                                <MudText Typo="Typo.caption" Style="color:#312121;" Class="ml-1">@blog.LikesCount</MudText>
                                                <MudIconButton Icon="@Icons.Material.Filled.Comment" Size="Size.Small" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))" Class="share-css ml-3" />
                                                <MudText Typo="Typo.caption" Style="color:#312121;" Class="ml-1"></MudText>
                                            </MudStack>
                                        </MudStack>
                                        <MudSpacer />
                                        <MudStack Row="true">
                                            <MudStack Row="true" Spacing="0">
                                                <MudCheckBox T="bool" Value="@SavedIds.Contains(blog.Id)" ValueChanged="@(checkedValue => ToggleSave(blog.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Bookmark" UncheckedIcon="@Icons.Material.Filled.BookmarkBorder" Style="padding-top:3px;" Class="like-button-css save-css ml-2"></MudCheckBox>
                                                <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" @onclick="@(() => SharePost(blog))" Class="share-css ml-2" />

                                                <MudMenu Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" Class="share-css ml-2">
                                                    <MudContainer Style="height:100%;width:220px;padding:0;">
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Not Interested</MudText>
                                                        <MudDivider></MudDivider>
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Follow author</MudText>
                                                        <MudDivider></MudDivider>
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Mute author</MudText>
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;padding-top:0;;color:rgb(170,0,0)">Report story...</MudText>
                                                    </MudContainer>
                                                </MudMenu>

                                            </MudStack>
                                        </MudStack>
                                    </MudContainer>
                                </MudItem>
                                <MudItem sm="3" md="4">
                                    <MudContainer style="display:flex;justify-content:center;align-items:center;width:100%;height:100%;padding:0;cursor:pointer;" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))">
                                        <MudImage Src="@blog.CoverImageUrl" Alt="@blog.Title" Style="width:100%;height:100%;padding-top:50px;padding-bottom:40px;padding-right:20px;" />
                                    </MudContainer>
                                </MudItem>
                            </MudGrid>
                        </MudContainer>
                        <MudDivider />
                    </MudItem>
                }
            </MudGrid>
    }


}
</div>;





//history code logic
RenderFragment HistoryTab() => @<div>

@{
    // <div class="d-flex align-center">

    //     <MudSpacer />
    // <MudButton Variant="Variant.Filled" Style="background:#a8a5cf;color:black;" Color="Color.Error" OnClick="ClearHistory">Clear History</MudButton>
    // </div>
}

@if (!HistoryBlogs.Any())
{
        <MudContainer Class="pa-6 d-flex flex-column align-center" Style="background-color:transparent" Elevation="0">
            <MudText Typo="Typo.h6">No read history found</MudText>
            <MudText Typo="Typo.body2" Class="mb-3">Read articles and they'll appear here.</MudText>
        </MudContainer>
}
else
{
    @if (isGridView)
    {
            <MudGrid Class="mt-3">
                @foreach (var b in HistoryBlogs)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudPaper Class="pa-2 mb-3" Elevation="4" Style="background: rgba(193, 188, 214,0.3);;height:100%;">
                            <MudContainer Style="min-height:280px;margin:0;padding:0;">
                                <img src="@b.CoverImageUrl" alt="@b.Title" style="width:100%;height:140px;object-fit:cover;border-radius:4px" />
                                <MudText Typo="Typo.subtitle1" Class="mt-2 font-bold cursor-pointer" Style="color:#004d40" @onclick="@(() => GoToBlog(b.Slug, b.Id))">@b.Title</MudText>
                                <MudText Typo="Typo.caption">@b.AuthorName • @b.CreatedAt?.ToString("MMM dd, yyyy")</MudText>
                                <MudText Typo="Typo.body2" Class="mt-1">@b.Content.Substring(3, 50)...</MudText>
                            </MudContainer>

                            <div class="d-flex align-center mt-2">
                                <MudCheckBox T="bool" Value="@LikedIds.Contains(b.Id)" ValueChanged="@(checkedValue => ToggleLike(b.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder" Class="like-button-css ml-3"></MudCheckBox>
                                <MudCheckBox T="bool" Value="@SavedIds.Contains(b.Id)" ValueChanged="@(checkedValue => ToggleSave(b.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Bookmark" UncheckedIcon="@Icons.Material.Filled.BookmarkBorder" Style="padding-top:3px;" Class="like-button-css save-css ml-2"></MudCheckBox>
                                <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" @onclick="@(() => SharePost(b))" Class="share-css ml-2" />
                                <MudSpacer />
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => GoToBlog(b.Slug, b.Id))">Read</MudButton>
                            </div>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
    }
    else
    {
            <MudGrid>
                @foreach (var blog in HistoryBlogs)
                {
                    <MudItem xs="12" md="6">
                        <MudContainer Style="margin-top:10px;margin-bottom:10px;padding:0;" Elevation="3">
                            <MudGrid>
                                @* content *@
                                <MudItem sm="9" md="8">
                                    <MudContainer Style="margin:0;padding:0;min-height:230px;">
                                        <MudContainer Style="padding:10px;">
                                            <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                <MudAvatar Size="Size.Small" Style="background-color:#3f51b5;color:white;">@(blog.AuthorName.First())</MudAvatar>
                                                <MudText Typo="Typo.caption" Style="padding-top:3px;">@blog.AuthorName</MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.h5" Style="color:#212121;cursor:pointer;font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;font-weight:800;" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))" Class="mt-3">@blog.Title</MudText>
                                            <MudText Typo="Typo.body1" Truncate="true" style="color:#757575">
                                                @((blog.Content?.Length > 150) ? blog.Content.Substring(3, 100) + "..." : blog.Content.Substring(3, blog.Content.Length - 3))
                                            </MudText>
                                        </MudContainer>
                                    </MudContainer>
                                    <MudContainer Style="display:flex;justify-content:start;padding-left:10px;width:100%">
                                        <MudStack Row="true">
                                            <MudStack Row="true" Spacing="0" Style="padding-top:3px">
                                                <MudText Typo="Typo.caption" Style="color:#312121">@blog.CreatedAt?.Date.ToString("MMM dd")</MudText>
                                                <MudCheckBox T="bool" Value="@LikedIds.Contains(blog.Id)" ValueChanged="@(checkedValue => ToggleLike(blog.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder" Class="like-button-css ml-3"></MudCheckBox>
                                                <MudText Typo="Typo.caption" Style="color:#312121;" Class="ml-1">@blog.LikesCount</MudText>
                                                <MudIconButton Icon="@Icons.Material.Filled.Comment" Size="Size.Small" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))" Class="share-css ml-3" />
                                                <MudText Typo="Typo.caption" Style="color:#312121;" Class="ml-1"></MudText>
                                            </MudStack>
                                        </MudStack>
                                        <MudSpacer />
                                        <MudStack Row="true">
                                            <MudStack Row="true" Spacing="0">
                                                <MudCheckBox T="bool" Value="@SavedIds.Contains(blog.Id)" ValueChanged="@(checkedValue => ToggleSave(blog.Id, checkedValue))" Color="Color.Secondary" Size="Size.Small" CheckedIcon="@Icons.Material.Filled.Bookmark" UncheckedIcon="@Icons.Material.Filled.BookmarkBorder" Style="padding-top:3px;" Class="like-button-css save-css ml-2"></MudCheckBox>
                                                <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" @onclick="@(() => SharePost(blog))" Class="share-css ml-2" />

                                                <MudMenu Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" Class="share-css ml-2">
                                                    <MudContainer Style="height:100%;width:220px;padding:0;">
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Not Interested</MudText>
                                                        <MudDivider></MudDivider>
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Follow author</MudText>
                                                        <MudDivider></MudDivider>
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;">Mute author</MudText>
                                                        <MudText Typo="Typo.subtitle2" Style="padding:10px;margin-left:6px;padding-top:0;;color:rgb(170,0,0)">Report story...</MudText>
                                                    </MudContainer>
                                                </MudMenu>

                                            </MudStack>
                                        </MudStack>
                                    </MudContainer>
                                </MudItem>
                                <MudItem sm="3" md="4">
                                    <MudContainer style="display:flex;justify-content:center;align-items:center;width:100%;height:100%;padding:0;cursor:pointer;" @onclick="@(() => GoToBlog(blog.Slug, blog.Id))">
                                        <MudImage Src="@blog.CoverImageUrl" Alt="@blog.Title" Style="width:100%;height:100%;padding-top:50px;padding-bottom:40px;padding-right:20px;" />
                                    </MudContainer>
                                </MudItem>
                            </MudGrid>
                        </MudContainer>
                        <MudDivider />
                    </MudItem>
                }
            </MudGrid>
    }
}
</div>;



    }

<style>

    .like-checkbox .mud-icon-root .mud-icon-button {
        padding: 0 !important;
    }

    .font-bold {
        font-weight: 700;
    }

    .custom-tabs .mud-tab-active {
        color: #ff5722 !important;
    }

    .custom-tabs .mud-tabs-tabbar {
        background-color: #edf2f5;
    }

    .custom-tabs .mud-tab-slider {
        background-color: #3f51b5 !important; /* Choose any color you want */
    }

    body {
        background: linear-gradient(to bottom, #ffffff, #ede9ff);
    }

    .like-button-css .mud-icon-button {
        padding: 0;
    }

    .share-css {
        padding: 0 !important;
    }

    .allblogs-container {
        margin-top: 24px;
        margin-bottom: 24px;
        min-height: 90vh;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .allblogs-shell {
        padding: 24px 28px;
        border-radius: 24px;
        /* background: linear-gradient(135deg, #EEF2FF 0%, #E0ECFF 100%); */
        background: rgba(233, 230, 245,0.4);
        box-shadow: 0 24px 40px rgba(15, 23, 42, 0.12), 0 0 0 1px rgba(148, 163, 184, 0.12);
    }

    .allblogs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .allblogs-title {
        font-weight: 600;
        color: #111827;
    }

    .allblogs-subtitle {
        color: #6B7280;
    }

    .allblogs-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
        align-items: center;
    }

    .allblogs-search {
        flex: 1 1 280px;
    }

    .allblogs-filter-select {
        min-width: 160px;
    }
</style>