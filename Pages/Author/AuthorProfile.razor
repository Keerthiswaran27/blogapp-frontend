@page "/author/profile"
@layout ReaderLayout
@using BlogApp1.Shared
@using BlogApp1.Client.Services
@using ASService.Services
@inject AuthService AuthService
@inject AdminService AdminService
@inject NewsletterService NewsletterService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="allblogs-container">
    @if (user is null || stats is null)
    {
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Style="height:600px;display:flex;justify-content:center;align-items:center;">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mt-5" />
        </MudContainer>
    }
    else
    {

        <MudPaper Elevation="8" Class="allblogs-shell">
            <!-- Header -->
            <div class="allblogs-header">
                <div>
                    <MudText Typo="Typo.h4" Class="allblogs-title">
                        Your Account
                    </MudText>
                    <MudText Typo="Typo.body2" Class="allblogs-subtitle">
                        Your personal space to manage account and activity.
                    </MudText>
                </div>
            </div>
            <MudGrid Spacing="5">
                <!-- Left Column -->
                <MudItem md="8">
                    <MudPaper Class="pa-2 mb-3" Elevation="4" Style="background: rgba(193, 188, 214,0.3);border-radius:16px; display:flex; flex-direction:column; gap:16px;">
                        <MudGrid Style="height:200px;">
                            <MudItem md="3">
                                <MudContainer Style="padding:10px;height:100%;">
                                    @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                    {
                                        <MudAvatar Style="height:100%; width:100%; cursor:pointer;">
                                            <MudImage Src="@user.AvatarUrl" />
                                        </MudAvatar>
                                    }
                                    else
                                    {
                                        <MudAvatar Style="height:100%; width:100%; font-size:5rem;background-color:#3f51b5;color:white;">
                                            @user.FullName.First()
                                        </MudAvatar>
                                    }
                                </MudContainer>
                            </MudItem>
                            <MudItem md="8">
                                <MudGrid Style="display:flex;justify-content:center;align-items:center;margin-top:8px;">
                                    <MudItem md="3">
                                        <MudStack Spacing="0" Justify="Justify.Center" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.h6" Align="Align.Center">Followers</MudText>
                                            <MudText Typo="Typo.h6" Align="Align.Center">@(user.Follower?.Count() ?? 0)</MudText>
                                        </MudStack>
                                    </MudItem>
                                    <MudItem md="3">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.h6" Align="Align.Center">Following</MudText>
                                            <MudText Typo="Typo.h6" Align="Align.Center">@(user.Following?.Count() ?? 0)</MudText>
                                        </MudStack>
                                    </MudItem>
                                    <MudItem md="3">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.h6" Align="Align.Center">Posts</MudText>
                                            <MudText Typo="Typo.h6" Align="Align.Center">@user.PostCount</MudText>
                                        </MudStack>
                                    </MudItem>
                                    <MudItem md="3">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.h6" Align="Align.Center">Views</MudText>
                                            <MudText Typo="Typo.h6" Align="Align.Center">@user.ViewCount</MudText>
                                        </MudStack>
                                    </MudItem>
                                    <MudItem md="12">
                                        <MudDivider Style="border-color:darkgray" />
                                        <MudStack Row="true" Justify="Justify.Center" Spacing="5" Style="margin:10px;">
                                            <MudIconButton Icon="@Icons.Custom.Brands.Twitter" Href="@user.Twitter" Color="Color.Primary" Size="Size.Medium" />

                                            <MudIconButton Icon="@Icons.Custom.Brands.LinkedIn" Href="@user.LinkedIn" Color="Color.Primary" Size="Size.Medium" />

                                            <MudIconButton Icon="@Icons.Custom.Brands.Instagram" Href="@user.Instagram" Color="Color.Primary" Size="Size.Medium" />

                                            <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Color="Color.Primary" Size="Size.Medium" Href="@user.Github" />

                                            <MudIconButton Icon="@Icons.Custom.Brands.Facebook" Color="Color.Primary" Size="Size.Medium" Href="@user.Medium" />
                                        </MudStack>
                                    </MudItem>
                                </MudGrid>
                            </MudItem>
                        </MudGrid>
                        <MudDivider Style="border-color:darkgray" />
                        <MudContainer Style="padding:5px;">
                            <MudGrid Spacing="2">
                                <MudItem md="4">
                                    <MudTextField @bind-Value="user.FullName" Label="Username" Disabled="true" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem md="4">
                                    <MudTextField @bind-Value="user.Email" Label="Email" Disabled="true" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem md="4">
                                    <MudDatePicker Label="Joined On" @bind-Date="user.CreatedAt" Disabled="true" Placeholder="Select Date" Variant="Variant.Outlined" />
                                </MudItem>
                            </MudGrid>
                        </MudContainer>
                        <MudContainer Style="padding:5px;margin-top:20px;margin-bottom:20px;">
                            <MudGrid>
                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Class="pa-3" Style="background: rgba(193, 188, 214,0.3);border-radius:16px;">
                                        <MudText Typo="Typo.subtitle2">Liked posts</MudText>
                                        <MudText Typo="Typo.h5">@stats?.LikedCount</MudText>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Class="pa-3" Style="background: rgba(193, 188, 214,0.3);border-radius:16px;">
                                        <MudText Typo="Typo.subtitle2">Saved posts</MudText>
                                        <MudText Typo="Typo.h5">@stats?.SavedCount</MudText>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Class="pa-3" Style="background: rgba(193, 188, 214,0.3);border-radius:16px;">
                                        <MudText Typo="Typo.subtitle2">Read history</MudText>
                                        <MudText Typo="Typo.h5">@stats?.ReadHistoryCount</MudText>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Class="pa-3" Style="background: rgba(193, 188, 214,0.3);border-radius:16px;">
                                        <MudText Typo="Typo.subtitle2">Comments</MudText>
                                        <MudText Typo="Typo.h5">@stats?.CommentCount</MudText>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>
                        </MudContainer>
                    </MudPaper>

                </MudItem>
                <MudItem md="4">
                    <MudPaper Class="pa-2 mb-3" Elevation="4" Style="background: rgba(193, 188, 214,0.3);border-radius:16px; display:flex; flex-direction:column; gap:16px;">
                        <MudGrid>
                            <MudItem md="12">
                                <MudContainer Style="height:300px;padding:5px;margin:0;border-radius:16px;border:0.5px solid black ">
                                    <MudTabs @bind-ActivePanelIndex="activeIndex" Class="custom-tabs">
                                        <MudTabPanel Class="c1" Text=@("Follwers")></MudTabPanel>
                                        <MudTabPanel Class="c1" Text="@("Following")"></MudTabPanel>
                                    </MudTabs>
                                    <MudContainer Style="overflow-y:auto;height:250px;">
                                        @if (activeIndex == 0)
                                        {
                                            @if (Follower != null && Follower.Any())
                                            {
                                                @foreach (var followerName in Follower)
                                                {
                                                    <MudText Class="mt-2 mb-2 ml-2">@followerName</MudText>
                                                    <MudDivider Style="border-color:darkgray" />
                                                }
                                            }
                                            else
                                            {
                                                <MudText Align="Align.Center" Class="mt-5 mb-5" Color="Color.Surface">No followers yet.</MudText>
                                            }
                                        }
                                        else @if (activeIndex == 1)
                                        {
                                            @if (Following != null && Following.Any())
                                            {
                                                @foreach (var followingName in Following)
                                                {
                                                    <MudText Class="mt-2 mb-2 ml-2">@followingName</MudText>
                                                    <MudDivider Style="border-color:darkgray" />
                                                }
                                            }
                                            else
                                            {
                                                <MudText Align="Align.Center" Class="mt-5 mb-5" Color="Color.Surface">No followers yet.</MudText>
                                            }
                                        }
                                    </MudContainer>
                                </MudContainer>
                            </MudItem>
                            <MudItem md="12">
                                <MudContainer Style="height:100px;padding:5px;margin:0;border-radius:16px;border:0.5px solid black ">
                                    <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-1">ROLES</MudText>
                                    <MudChipSet T="string" Size="Size.Large" Style="display:flex;justify-content:center">
                                        @foreach (var c in user.Roles)
                                        {
                                            <MudChip Variant="Variant.Outlined">@c</MudChip>
                                        }
                                    </MudChipSet>
                                </MudContainer>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
                <MudItem md="12">
                    <MudPaper Class="pa-4 mb-3" Elevation="4" Style="background: rgba(193, 188, 214,0.3);border-radius:16px; display:flex; flex-direction:column; gap:16px;">
                        <div class="allblogs-header">
                            <div>
                                <MudText Typo="Typo.h5" Class="allblogs-title">
                                    Join Our Newsletter
                                </MudText>
                                <MudText Typo="Typo.body2" Class="allblogs-subtitle">
                                    Curated reads, insights, and updates—straight to your inbox.
                                </MudText>
                            </div>
                        </div>
                        <MudGrid>
                            <MudItem xs="9">
                                <MudTextField @bind-Value="newsletterEmail"
                                              Label="Enter your email"
                                              Variant="Variant.Outlined"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Email"
                                              Immediate="true"
                                              FullWidth="true"
                                              Class="allblogs-search" />
                            </MudItem>
                            <MudItem xs="3">
                                <MudButton Variant="Variant.Filled"
                                           Class="ml-2"
                                           FullWidth="true"
                                           Style="height:80%;background-color:#3d387a;color:white;font-size:larger"
                                           OnClick="SubscribeAsync">
                                    Subscribe
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>

        </MudPaper>

        @* <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h6">Profile</MudText>
                <MudDivider Class="my-2" />

                <MudStack Spacing="1">
                    <MudText><b>Name:</b> @user.FullName</MudText>
                    <MudText><b>Username:</b> @user.Username</MudText>
                    <MudText><b>Email:</b> @user.Email</MudText>
                    <MudText><b>Location:</b> @user.Location</MudText>
                    <MudText><b>Website:</b> @user.WebsiteUrl</MudText>
                    <MudText><b>Bio:</b> @user.Bio</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h6">Stats</MudText>
                <MudDivider Class="my-2" />

                <MudStack Spacing="1">
                    <MudText><b>Liked posts:</b> @stats.LikedCount</MudText>
                    <MudText><b>Saved posts:</b> @stats.SavedCount</MudText>
                    <MudText><b>Read history:</b> @stats.ReadHistoryCount</MudText>
                    <MudText><b>Comments:</b> @stats.CommentCount</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mb-2" OnClick="ToggleEdit">
        @(showEdit ? "Hide Edit Profile" : "Edit Profile")
    </MudButton>

    <MudCollapse Expanded="showEdit">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6">Edit Profile</MudText>
            <MudDivider Class="my-2" />

            <EditForm Model="editModel" OnValidSubmit="SaveProfile">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <MudStack Spacing="2">
                    <MudTextField @bind-Value="editModel.FullName"
                                  Label="Full Name"
                                  Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="editModel.Username"
                                  Label="Username"
                                  Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="editModel.Email"
                                  Label="Email"
                                  Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="editModel.Location"
                                  Label="Location"
                                  Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="editModel.WebsiteUrl"
                                  Label="Website"
                                  Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="editModel.Bio"
                                  Label="Bio"
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  Text="@editModel.Bio" />

                    <MudButton Color="Color.Success"
                               Variant="Variant.Filled"
                               ButtonType="ButtonType.Submit"
                               Disabled="isSaving">
                        @(isSaving ? "Saving..." : "Save Changes")
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudPaper>
    </MudCollapse> *@
    }
</MudContainer>
@code {
    private BlogUserDto? user;
    private BlogUserDto editModel = new();
    private UserStatsDto? stats;
    private bool showEdit = false;
    private bool isSaving = false;
    private int activeIndex = 0;
    List<string> Follower = new();
    List<string> Following = new();
    private bool NewsLetterStatus = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
        NewsLetterStatus = await NewsletterService.IsSubscribedAsync();
    }
    private string? newsletterEmail;

    private async Task SubscribeAsync()
    {
        bool result = await NewsletterService.SubscribeAsync(newsletterEmail);

        if (result)
        {
            Snackbar.Add("Newsletter subscribed", Severity.Success);
        }
        else
        {
            Snackbar.Add("Subscription failed. Please try again.", Severity.Error);
        }
    }

    private async Task LoadDataAsync()
    {

        try
        {
            user = await AuthService.GetUserInfoAsync();
            stats = await AuthService.GetUserStatsAsync();

            if (user != null)
            {
                // Make sure follower/following arrays are not null
                var followerIds = user.Follower?.ToList() ?? new List<string>();
                var followingIds = user.Following?.ToList() ?? new List<string>();

                // Call the services
                Follower = await AdminService.GetFollowersAsync(followerIds);
                Following = await AdminService.GetFollowingAsync(followingIds);

                // Debug logs
                foreach (var f in Follower)
                    Console.WriteLine($"Follower: {f}");

                foreach (var f in Following)
                    Console.WriteLine($"Following: {f}");
                foreach (var f in followerIds)
                    Console.WriteLine($"FollowerIds: {f}");

                foreach (var f in followingIds)
                    Console.WriteLine($"FollowingIds: {f}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user data: {ex.Message}");
            user = null;
            Follower = new List<string>();
            Following = new List<string>();
        }
        if (user is not null)
        {
            editModel = new BlogUserDto
            {
                Id = user.Id,
                UserId = user.UserId,
                FullName = user.FullName,
                Username = user.Username,
                Email = user.Email,
                AvatarUrl = user.AvatarUrl,
                Bio = user.Bio,
                Location = user.Location,
                WebsiteUrl = user.WebsiteUrl,
                Twitter = user.Twitter,
                LinkedIn = user.LinkedIn,
                Github = user.Github,
                Instagram = user.Instagram,
                Medium = user.Medium,
                Roles = user.Roles,
                IsActive = user.IsActive,
                IsVerified = user.IsVerified,
                PostCount = user.PostCount,
                ViewCount = user.ViewCount,
                EmailNotifications = user.EmailNotifications,
                NewsletterSubscribed = user.NewsletterSubscribed,
                Theme = user.Theme,
                Language = user.Language,
                LikeId = user.LikeId,
                SavedId = user.SavedId,
                Following = user.Following,
                Follower = user.Follower,
                ReadHistory = user.ReadHistory,
                UserPreference = user.UserPreference
            };
        }
    }

    private void ToggleEdit()
    {
        showEdit = !showEdit;
    }

    private async Task SaveProfile()
    {
        if (editModel is null)
            return;

        isSaving = true;

        var updated = await AuthService.UpdateProfileAsync(editModel);

        if (updated is not null)
        {
            user = updated;
        }

        isSaving = false;
        showEdit = false;
    }
}
<style>
    .allblogs-container {
        margin-top: 24px;
        margin-bottom: 24px;
        min-height: 90vh;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .allblogs-shell {
        padding: 24px 28px;
        border-radius: 24px;
        /* background: linear-gradient(135deg, #EEF2FF 0%, #E0ECFF 100%); */
        background: rgba(233, 230, 245,0.4);
        box-shadow: 0 24px 40px rgba(15, 23, 42, 0.12), 0 0 0 1px rgba(148, 163, 184, 0.12);
    }

    .allblogs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .allblogs-title {
        font-weight: 600;
        color: #111827;
    }

    .allblogs-subtitle {
        color: #6B7280;
    }

    .allblogs-search {
        flex: 1 1 280px;
    }

    .custom-tabs .mud-tabs-tabbar {
        background: rgba(233, 230, 245,0.4);
    }

    .custom-tabs .mud-tab-slider {
        background-color: #3f51b5 !important; /* Choose any color you want */
    }

    body {
        background: linear-gradient(to bottom, #ffffff, #ede9ff);
        height: 100%;
    }
</style>