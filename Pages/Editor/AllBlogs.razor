@page "/editor/allblogs"
@layout EditorLayout
@using BlogApp1.Shared
@using MudBlazor
@using BSService.Services
@inject BlogService BSService
@inject NavigationManager Nav

<PageTitle>All Blogs - Editor</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="allblogs-container">
    <MudPaper Elevation="8" Class="allblogs-shell">
        <!-- Header -->
        <div class="allblogs-header">
            <div>
                <MudText Typo="Typo.h4" Class="allblogs-title">
                    All Blogs
                </MudText>
                <MudText Typo="Typo.body2" Class="allblogs-subtitle">
                    Browse, search and open any blog for detailed review
                </MudText>
            </div>
        </div>

        <!-- Search + Filters -->
        <div class="allblogs-filters">
            <MudTextField @bind-Value="SearchText"
                          Placeholder="Search by title or author..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="allblogs-search"
                          Immediate="true"
                          DebounceInterval="250" />

            <MudSelect T="string" @bind-Value="StatusFilter"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Label="Status"
                       Class="allblogs-filter-select">
                <MudSelectItem T="string" Value="@("all")">All</MudSelectItem>
                <MudSelectItem T="string" Value="@("draft")">Draft</MudSelectItem>
                <MudSelectItem T="string" Value="@("pending")">Pending</MudSelectItem>
                <MudSelectItem T="string" Value="@("approved")">Approved</MudSelectItem>
                <MudSelectItem T="string" Value="@("rejected")">Rejected</MudSelectItem>
                <MudSelectItem T="string" Value="@("revise")">Revise</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" @bind-Value="DomainFilter"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Label="Domain"
                       Class="allblogs-filter-select">
                <MudSelectItem T="string" Value="@("all")">All</MudSelectItem>
                @foreach (var d in _distinctDomains)
                {
                    <MudSelectItem T="string" Value="@d">@d</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="string" @bind-Value="SortOption"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Label="Sort"
                       Class="allblogs-filter-select">
                <MudSelectItem T="string" Value="@("created_desc")">Newest first</MudSelectItem>
                <MudSelectItem T="string" Value="@("created_asc")">Oldest first</MudSelectItem>
                <MudSelectItem T="string" Value="@("views_desc")">Most viewed</MudSelectItem>
                <MudSelectItem T="string" Value="@("views_asc")">Least viewed</MudSelectItem>
            </MudSelect>
        </div>

        <!-- Table -->
        <MudTable Items="_filteredBlogs"
                  Hover="true"
                  Dense="true"
                  Bordered="false"
                  Elevation="0"
                  Class="allblogs-table">
            <HeaderContent>
                <MudTh>Title</MudTh>
                <MudTh>Author</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Domain</MudTh>
                <MudTh>Views</MudTh>
                <MudTh>Created</MudTh>
                <MudTh class="text-right">Action</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudText Typo="Typo.body2" Class="allblogs-title-cell">
                        @context.Title
                    </MudText>
                </MudTd>

                <MudTd>
                    <MudText Typo="Typo.body2">@context.AuthorName</MudText>
                </MudTd>

                <MudTd>
                    <MudChip T="string" Color="@GetStatusColor(context.Status)"
                             Size="Size.Small"
                             Variant="Variant.Filled">
                        @(string.IsNullOrWhiteSpace(context.Status) ? "Unknown" : context.Status)
                    </MudChip>
                </MudTd>

                <MudTd>@context.Domain</MudTd>

                <MudTd>
                    <MudText Typo="Typo.body2">@context.ViewCount</MudText>
                </MudTd>

                <MudTd>
                    <MudText Typo="Typo.body2">
                        @context.CreatedAt?.ToLocalTime().ToString("dd MMM yyyy")
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @context.CreatedAt?.ToLocalTime().ToString("HH:mm")
                    </MudText>
                </MudTd>

                <MudTd Class="text-right">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               Class="rounded-pill"
                               OnClick="@(() => NavigateToBlogDetails(context.Id))">
                        Review
                    </MudButton>
                </MudTd>
            </RowTemplate>

            <NoRecordsContent>
                <MudText Typo="Typo.body2" Class="pa-4">
                    No blogs match the current filters.
                </MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

<style>
    .allblogs-container {
        margin-top: 24px;
        margin-bottom: 24px;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .allblogs-shell {
        padding: 24px 28px;
        border-radius: 24px;
        /* background: linear-gradient(135deg, #EEF2FF 0%, #E0ECFF 100%); */
        background: rgba(233, 230, 245,0.4);    
        box-shadow: 0 24px 40px rgba(15, 23, 42, 0.12), 0 0 0 1px rgba(148, 163, 184, 0.12);
    }

    .allblogs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        
    }

    .allblogs-title {
        font-weight: 600;
        color: #111827;
    }

    .allblogs-subtitle {
        color: #6B7280;
    }

    .allblogs-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
        align-items: center;
    }

    .allblogs-search {
        flex: 1 1 280px;
    }

    .allblogs-filter-select {
        min-width: 160px;
    }

    .allblogs-table,
    .allblogs-table * {
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

        .allblogs-table .mud-table-head {
            background-color: #a8a5cf;
        }

            .allblogs-table .mud-table-head th {
                font-weight: 600;
                color: #111827;
            }

        .allblogs-table .mud-table-body .mud-table-row:hover {
            background-color: rgba(99, 102, 241, 0.04);
            cursor: pointer;
        }

    .allblogs-title-cell {
        font-weight: 500;
    }

    @@media (max-width: 768px) {
        .allblogs-shell {
            padding: 16px 12px;
            border-radius: 18px;
        }

        .allblogs-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
    }
</style>

@code {
    private List<BlogDto>? blogs;
    private List<BlogDto> _filteredBlogs = new();

    // Internal backing fields
    private string _searchText = string.Empty;
    private string _statusFilter = "all";
    private string _domainFilter = "all";
    private string _sortOption = "created_desc";

    private HashSet<string> _distinctDomains = new();

    // Properties used by @bind so we can hook ApplyFilters()
    private string SearchText
    {
        get => _searchText;
        set
        {
            _searchText = value;
            ApplyFilters();
        }
    }

    private string StatusFilter
    {
        get => _statusFilter;
        set
        {
            _statusFilter = value;
            ApplyFilters();
        }
    }

    private string DomainFilter
    {
        get => _domainFilter;
        set
        {
            _domainFilter = value;
            ApplyFilters();
        }
    }

    private string SortOption
    {
        get => _sortOption;
        set
        {
            _sortOption = value;
            ApplyFilters();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        blogs = await BSService.GetAllBlogsAsync();

        if (blogs is null)
            blogs = new List<BlogDto>();

        _distinctDomains = blogs
            .Select(b => b.Domain)
            .Where(d => !string.IsNullOrWhiteSpace(d))
            .OrderBy(d => d)
            .ToHashSet();

        ApplyFilters();
    }

    private void NavigateToBlogDetails(int blogId)
    {
        Nav.NavigateTo($"/editor/review/{blogId}");
    }

    private void ApplyFilters()
    {
        if (blogs is null)
        {
            _filteredBlogs = new();
            return;
        }

        IEnumerable<BlogDto> query = blogs;

        // Search by title or author (case-insensitive)
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            var term = _searchText.Trim();
            query = query.Where(b =>
                (!string.IsNullOrEmpty(b.Title) &&
                    b.Title.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(b.AuthorName) &&
                    b.AuthorName.Contains(term, StringComparison.OrdinalIgnoreCase)));
        }

        // Status filter ("all" = no filter)
        if (!string.Equals(_statusFilter, "all", StringComparison.OrdinalIgnoreCase))
        {
            query = query.Where(b =>
                string.Equals(b.Status, _statusFilter, StringComparison.OrdinalIgnoreCase));
        }

        // Domain filter ("all" = no filter)
        if (!string.Equals(_domainFilter, "all", StringComparison.OrdinalIgnoreCase))
        {
            query = query.Where(b =>
                string.Equals(b.Domain, _domainFilter, StringComparison.OrdinalIgnoreCase));
        }

        // Sort
        query = _sortOption switch
        {
            "created_asc" => query.OrderBy(b => b.CreatedAt ?? DateTime.MinValue),
            "views_desc" => query.OrderByDescending(b => b.ViewCount),
            "views_asc" => query.OrderBy(b => b.ViewCount),
            _ => query.OrderByDescending(b => b.CreatedAt ?? DateTime.MinValue)
        };

        _filteredBlogs = query.ToList();
    }

    private Color GetStatusColor(string? status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return Color.Default;

        return status.ToLower() switch
        {
            "pending" => Color.Warning,
            "approved" => Color.Success,
            "rejected" => Color.Error,
            "revise" => Color.Info,
            "draft" => Color.Secondary,
            _ => Color.Default
        };
    }
}
