@page "/admin"
@* @using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")] *@
<PageTitle>Admin</PageTitle>
@layout AdminLayout
@using MudBlazor
@using BlogApp1.Shared
@using BSService.Services
@using BlogApp1.Client.Services
@inject CommentService CommentService
@inject BlogService BSService
@using ChartJs.Blazor.Common
@using ChartJs.Blazor.LineChart
@using ChartJs.Blazor.BarChart
@using ChartJs.Blazor.PieChart
@using ChartJs.Blazor.Util
@inject NavigationManager NavigationManager

<MudContainer Class="pa-4" >
    <MudText Typo="Typo.h2" Align="Align.Center" style="font-weight:600">OVERALL DASHBOARD</MudText>
    <!-- ===== Row 1: Quick Stats ===== -->
    <MudGrid Gutter="3" Style="margin-top:10px;">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stats-cards pa-4" Elevation="4">
                <MudText Typo="Typo.h6">Total Users</MudText>
                <MudText Typo="Typo.h4" Color="Color.Primary">8</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stats-cards pa-4" Elevation="4">
                <MudText Typo="Typo.h6">Active Users</MudText>
                <MudText Typo="Typo.h4" Color="Color.Success">3</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stats-cards pa-4" Elevation="4">
                <MudText Typo="Typo.h6">Total Posts</MudText>
                <MudText Typo="Typo.h4" Color="Color.Info">27</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="stats-cards pa-4" Elevation="4">
                <MudText Typo="Typo.h6">Pending Approvals</MudText>
                <MudText Typo="Typo.h4" Color="Color.Warning">4</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- ===== Row 2: Charts ===== -->
    <MudGrid Gutter="3" Class="mt-4" style="margin-bottom:30px;">
        <MudItem xs="12" md="4">
            <MudPaper Class="stats-cards pa-4" Elevation="4" Style="height:100%">
                <MudText Typo="Typo.h6">Monthly Users</MudText>
                @if (lineConfig != null)
                {
                    <Chart Config="@lineConfig" />
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="stats-cards pa-4" Elevation="4">
                <MudText Typo="Typo.h6">Monthly Posts</MudText>
                @if (barConfig != null)
                {
                    <Chart Config="@barConfig" />
                }

                <MudStack Row="true" Justify="Justify.Center" Spacing="0">
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#c24e6d" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Tech</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#4e78c2" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">LifeStyle</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#93cc68" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Education</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#dbce79" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">News</MudText>
                </MudStack>
                <MudStack Row="true" Justify="Justify.Center" Class="mt-1" Spacing="0">
                    
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#b58353" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Food</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#b36ce6" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Travel</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#6cd7e6" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Health</MudText>

                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="stats-cards pa-4" Elevation="4" Style="height:100%;">
                <MudText Typo="Typo.h6">Category Distribution</MudText>

                @if (pieConfig != null)
                {
                    <Chart Config="@pieConfig" />
                }
                <MudStack Row="true" Justify="Justify.Center" Class="mt-2" Spacing="0">
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:lightgreen" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Published</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:lightpink" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Draft</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:lightblue" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Pending Review</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.Circle" style="color:#c24e6d" Class="ml-2" Size="Size.Small" />
                    <MudText Typo="Typo.caption">Rejected</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
    </MudContainer>
<MudContainer Style="padding-top:10px;">
    <MudText Typo="Typo.h2" Align="Align.Center" style="font-weight:600">RECENT STATS</MudText>

    <!-- ===== Row 3: Recent Details Table ===== -->
    <MudGrid Class="mt-4">
        <MudItem xs="12" md="6">
            <MudPaper Class="stats-cards pa-4" Elevation="4" Style="height:100%">
                <MudText Typo="Typo.h6">Recent Registration</MudText>
                <MudTable Items="@Users" Elevation="0" Dense="true" Hover="true" HideToolbar="true">
                    <HeaderContent>
                        <MudTh Style="font-weight:800;color:#4e78c2">USERNAME</MudTh>
                        <MudTh Style="font-weight:800;color:#4e78c2">EMAIL</MudTh>
                        <MudTh Style="font-weight:800;color:#4e78c2">ROLE</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Username">@context.Username</MudTd>
                        <MudTd DataLabel="Email">@context.Email</MudTd>
                        <MudTd DataLabel="Role">@context.Role</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="stats-cards pa-4" Elevation="4" Style="height:100%;">
                <MudText Typo="Typo.h6">Top Authors</MudText>
                <MudTable Items="@Authors" Elevation="0" Dense="true" Hover="true" HideToolbar="true">
                    <HeaderContent>
                        <MudTh Style="font-weight:800;color:#4e78c2">USERNAME</MudTh>
                        <MudTh Style="font-weight:800;color:#4e78c2">TOTAL POSTS</MudTh>
                        <MudTh Style="font-weight:800;color:#4e78c2">COMMENTS</MudTh>
                        <MudTh Style="font-weight:800;color:#4e78c2">LIKES</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Username">
                            <MudAvatar Size="Size.Small" Class="mr-1" Style="background-color:#ff5722;color:white;">@context.Username.First()</MudAvatar>
                            @context.Username
                        </MudTd>
                        <MudTd DataLabel="TotalPosts">@context.Posts</MudTd>
                        <MudTd DataLabel="Comments">@context.Comments</MudTd>
                        <MudTd DataLabel="Likes">@context.Likes</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
      
        <MudItem xs="12" md="6">
            <MudPaper Class="stats-cards pa-4" Elevation="4" Style="height:100%;">
                <MudText Typo="Typo.h5">Recently Posted Blogs</MudText>

                @if (Blogs == null)
                {
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                }
                else if (Blogs.Count == 0)
                {
                    <MudText>No blogs found.</MudText>
                }
                else
                {
                    @foreach (var blog in Blogs.OrderByDescending(p => p.CreatedAt).Take(3))
                    {
                    <MudContainer Style="padding:10px;">                      
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <MudAvatar Style="height:35px; width:35px; font-size:1rem;background-color:orange;color:white;">@blog.AuthorName.First()</MudAvatar>
                            <MudStack Spacing="0">
                                <MudText Style="padding:0;" Typo="Typo.caption">@blog.AuthorName</MudText>
                                <MudText Style="padding:0;color:grey;" Typo="Typo.caption">@blog.CreatedAt?.Date.ToString("MMM dd")</MudText>
                            </MudStack>
                            <MudSpacer />
                            <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Color="Color.Primary" />
                        </MudStack>
                        <MudText Typo="Typo.h5" Style="color:#212121;cursor:pointer;font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;font-weight:800;" @onclick="@(() => GoToBlog(blog.Id))" Class="mt-3">@blog.Title</MudText>
                        <MudStack Row="true" Class="mt-2">
                            <MudStack Row="true">
                                <MudChipSet T="string">
                                        <MudChip Variant="Variant.Outlined" Size="Size.Small" style="color:white;background-color:#ff5722">@blog.Status.ToUpper()</MudChip>
                                        <MudChip Variant="Variant.Outlined" Size="Size.Small" Color="Color.Transparent">@blog.Domain</MudChip>
                                </MudChipSet>
                            </MudStack>
                            <MudSpacer/>
                            <MudStack Row="true">
                                <MudButton Color="Color.Dark" Size="Size.Small" Variant="Variant.Filled" Style="border-radius:16px;" OnClick="()=>EditBlog(blog.Id)"> Edit </MudButton>
                                    <MudButton Color="Color.Error" Size="Size.Small" Variant="Variant.Outlined" Style="border-radius:16px;">Delete</MudButton>
                            </MudStack>
                        </MudStack>
                    </MudContainer>  
                    <MudDivider/>
                    }
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="stats-cards pa-4" Elevation="4" Style="height:100%;">
                <MudText Typo="Typo.h5">Recent Comments</MudText>
                @if (Comments == null)
                {
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                }
                else if (Comments.Count == 0)
                {
                    <MudText>No blogs found.</MudText>
                }
                else
                {
                    @foreach(var comment in Comments)
                    {
                        <MudContainer style="padding:10px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                <MudAvatar Style="height:35px; width:35px; font-size:1rem;background-color:orange;color:white;">@comment.AuthorName.First()</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Style="padding:0;" Typo="Typo.caption">@comment.AuthorName</MudText>
                                    <MudText Style="padding:0;color:grey;" Typo="Typo.caption">@comment.CreatedAt?.Date.ToString("MMM dd")</MudText>
                                </MudStack>
                                <MudSpacer />
                                <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Color="Color.Primary" />
                            </MudStack>
                            <MudText Typo="Typo.h6" Style="color:#212121;cursor:pointer;font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;font-weight:500;" Class="mt-3">@comment.Content</MudText>
                            <MudText Typo="Typo.subtitle2">
                                @comment.BlogTitle
                            </MudText>                            
                            <MudStack Row="true" Class="mt-2">
                                <MudStack Row="true">
                                    <MudText Typo="Typo.body2" Style="color:darkgrey">
                                        @foreach(var AuthorName in CommentAuthors)
                                        {
                                            @if(AuthorName.Commentuid==comment.CommentUid)
                                            {
                                                @($"Replying to {AuthorName.Name}")
                                            }
                                        }
                                    </MudText>
                                </MudStack>
                                <MudSpacer />
                                <MudStack Row="true">
                                    <MudButton style="background-color:black;color:white;" Size="Size.Small" Variant="Variant.Filled"  > Edit </MudButton>
                                    <MudButton Color="Color.Error" Size="Size.Small" Variant="Variant.Outlined" Class="stats-cards">Delete</MudButton>
                                </MudStack>
                            </MudStack>
                        </MudContainer>
                        <MudDivider/>
                    }
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- ===== Row 4: Action Buttons ===== -->
    @* <MudGrid Gutter="3" Class="mt-4">
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="me-2">Add User</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Info" Class="me-2">Manage Posts</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Warning">Verify Approvals</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid> *@
</MudContainer>



@code {
    private Stats TotalStats = new();

    private LineConfig lineConfig;
    private BarConfig barConfig;
    private PieConfig pieConfig;
    private List<BlogDto> Blogs = new();
    private List<CommentDto> Comments = new();
    private List<AuthorComment> CommentAuthors = new();

    protected override async Task OnInitializedAsync()
    {
        string[] months = { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul" };

        // ---------------- LINE CHART: Blogs per Month ----------------
        lineConfig = new LineConfig
        {
            Options = new LineOptions
            {
                Responsive = true,
                Title = new OptionsTitle { Display = false, Text = "Blogs Posted per Month" },
                Legend = new Legend
                {
                    Display = false // Hides the legend (the "Blogs" box)
                },
                Scales = new Scales
                {
                    XAxes = new List<CartesianAxis> { new CategoryAxis { GridLines = new GridLines { Display = false } } },
                    YAxes = new List<CartesianAxis> { new LinearCartesianAxis { GridLines = new GridLines { Display = true } } }
                }
            }
        };
        foreach (var month in months) lineConfig.Data.Labels.Add(month);
        var lineDataset = new LineDataset<double>
        {
            Label = "Blogs",
            Fill = false,
            BackgroundColor = "black",
            BorderColor = "black",
            // PointBackgroundColor = new List<string> { "black", "black", "black", "black", "black", "black", "black" }
        };
        lineDataset.AddRange(new double[] { 230,500,3000,120,700,1200,1400 }); // dummy: blogs per month
        lineConfig.Data.Datasets.Add(lineDataset);

        // ---------------- BAR CHART: Views per Category ----------------
        string[] categories = { "Tech", "LifeStyle", "Education", "News", "Food","Travel","Health" };
        barConfig = new BarConfig
        {
            Options = new BarOptions
            {
                Responsive = true,
                Title = new OptionsTitle
                {
                    Display = false // Hides the title
                },
                Legend = new Legend
                {
                    Display = false // Hides the legend
                },
                Scales = new BarScales
                {
                    XAxes = new List<CartesianAxis>
                    {
                        new CategoryAxis
                        {
                            Ticks = new ChartJs.Blazor.Common.Axes.Ticks.CategoryTicks
                            {
                                Display = false // Hides the X-axis labels
                            },
                            GridLines = new GridLines
                            {
                                Display = false,
                                DrawBorder = true
                            }
                        }
                    },

                    YAxes = new List<CartesianAxis> 
                    { 
                        new LinearCartesianAxis 
                        {   
                            GridLines = new GridLines 
                            { 
                                Display = true 
                            },
                            Ticks = new ChartJs.Blazor.Common.Axes.Ticks.LinearCartesianTicks
                            {
                              Min = 60,
                            }
                        } 
                    }
                }
            }
        };
        foreach (var category in categories) barConfig.Data.Labels.Add(category);
        var barDataset = new BarDataset<double>
        {
            Label = "Views",
            BackgroundColor = new IndexableOption<string>(new[] { "#c24e6d", "#4e78c2", "#93cc68", "#dbce79", "#b58353", "#b36ce6", "#6cd7e6" })
        };
        barDataset.AddRange(new double[] { 120, 80, 95, 160, 150,70,67 }); // dummy: views per category
        barConfig.Data.Datasets.Add(barDataset);

        // ---------------- PIE CHART: Blog Status ----------------
        string[] statuses = { "Published", "Draft", "Pending Review", "Rejected" };
        pieConfig = new PieConfig
        {
            Options = new PieOptions
            {
                Responsive = true,
                Title = new OptionsTitle
                {
                    Display = false // Hides the title
                },
                Legend = new Legend
                {
                    Display = false // Hides the legend
                }
            }
        };
        foreach (var status in statuses) pieConfig.Data.Labels.Add(status);
        var pieDataset = new PieDataset<double>
        {
            BackgroundColor = new IndexableOption<string>(new[] { "lightgreen", "lightpink", "lightblue", "#c24e6d" })
        };
        pieDataset.AddRange(new double[] { 45, 20, 25, 10 }); // dummy: percentage of blogs by status
        pieConfig.Data.Datasets.Add(pieDataset);
        TotalStats = await CommentService.GetTotalStatsAsync();
        Blogs = await BSService.GetAllBlogsAsync();
        Comments = await CommentService.GetRecentCommentsAsync();


        foreach (var comment in Comments)
        {
            if (comment.ParentCommentUid.HasValue)
            {
                var AuthorName = await CommentService.GetAuthorName(comment.ParentCommentUid);
                CommentAuthors.Add(new AuthorComment { Name = AuthorName, Commentuid = comment.CommentUid });
            }
            else
            {
                var AuthorName = await CommentService.GetAuthorUsingId(comment.BlogId);
                CommentAuthors.Add(new AuthorComment { Name = AuthorName, Commentuid = comment.CommentUid });
            }
        }
        foreach(var c in CommentAuthors)
        {
            Console.WriteLine($"{c.Name}");
        }
        foreach (var comment in Comments)
        {
            comment.BlogTitle = await CommentService.GetTitleAsync(comment.BlogId);
        }

    }
    private async Task<String> GetBlogTitleAsync(int id)
    {
        var Title = await CommentService.GetTitleAsync(id);
        return Title ?? string.Empty;
    }
    public class AuthorComment
    {
        public string Name {get;set;}
        public Guid Commentuid { get; set; }
    }
    //new user table
    public class User
    {
        public string Username { get; set; }
        public string Email { get; set; }
        public string Role { get; set; }
    }
    public class Author
    {
        public string Username { get; set; }
        public int Posts { get; set; }
        public int Comments { get; set; }
        public int Likes { get; set; }

    }
    private List<Author> Authors = new List<Author>
    {
        new Author { Username ="Keerthiswaran ",Posts=4,Comments=9,Likes=25 },
        new Author { Username ="SanthaSeelan",Posts=3,Comments=6,Likes= 14},
        new Author { Username ="Wahran",Posts=2,Comments=4,Likes=11 }
    };
    // A list to hold the user data
    private List<User> Users = new List<User>
    {
        new User { Username = "Rajalakshmi R", Email = "rajikumaresh20@gmail.com", Role = "Reader" },
        new User { Username = "Santha seelan", Email = "santhaseelan.js2023@vitstudent.ac.in", Role = "Editor" },
        new User { Username = "Wahran", Email = "keerthiswaran.kr2023@vitstudent.ac.in", Role = "Author" }
    };
    private void GoToBlog(int id)
    {
        NavigationManager.NavigateTo($"/admin/blogs/{id}");
    }
    private void EditBlog(int Id)
    {
        NavigationManager.NavigateTo($"/admin/blog/edit/{Id}");
    }
}
<style>
    .stats-cards{
        border-radius:16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.07);
    }
    .stats-cards:hover{
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    body{
        background: #FBFAFF;
    }
</style>