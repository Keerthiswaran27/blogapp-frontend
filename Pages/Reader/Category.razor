@page "/category/{Title}"
@layout AuthorLayour
@using BSService.Services
@using BlogApp1.Shared
@inject BlogService BSService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<MudBreakpointProvider OnBreakpointChanged="OnBreakpointChanged" />

<MudText Typo="Typo.h2"
         Class="mt-3 mb-3"
         Align="Align.Center"
         Style="color:#3d387a; font-family:'Poppins', 'Segoe UI', sans-serif;">
    @Title.ToUpper()
</MudText>

<MudContainer Class="container-2"
              Style="@ContainerStyle">

    @if (blogs == null)
    {
        <MudContainer MaxWidth="MaxWidth.ExtraLarge"
                      Style="height:600px;display:flex;justify-content:center;align-items:center;">
            <MudProgressCircular Indeterminate="true"
                                 Color="Color.Primary"
                                 Size="Size.Large"
                                 Class="mt-5" />
        </MudContainer>
    }
    else if (blogs.Count == 0)
    {
        <MudText>No blogs found.</MudText>
    }
    else
    {
        @foreach (var blog in blogs)
        {
            @if (blog.Domain.ToLower() == Title.ToLower())
            {
                <MudContainer MaxWidth="MaxWidth.Medium"
                              Class="d-flex justify-space-between p-3"
                              Style="margin-top:10px;margin-bottom:10px;"
                              Elevation="3">

                    <MudGrid>
                        @if(isMobile)
                        {
                            <MudItem xs="12" sm="12" md="4">
                            <MudContainer Style="display:flex;
                                                 justify-content:center;
                                                 align-items:center;
                                                 width:100%;height:100%;
                                                 padding:0;cursor:pointer;"
                                          @onclick="@(() => GoToBlog(blog.Slug))">

                                <MudImage Src="@blog.CoverImageUrl"
                                          Alt="@blog.Title"
                                          Style="@ImageStyle" />
                            </MudContainer>
                        </MudItem>
                        }
                        <!-- CONTENT -->
                        <MudItem xs="12" sm="12" md="8">
                            <MudContainer Style="padding:10px;">

                                <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                    <MudAvatar Size="Size.Small"
                                               Style="background-color:#3f51b5;color:white;">
                                        @(blog.AuthorName.First())
                                    </MudAvatar>
                                    <MudText Typo="Typo.caption"
                                             Style="padding-top:3px;">
                                        @blog.AuthorName
                                    </MudText>
                                </MudStack>

                                <MudText Typo="@(currentBp<=Breakpoint.Sm ? Typo.subtitle1 : Typo.h5)"
                                         Style="color:#212121;cursor:pointer;
                                                font-family:'Franklin Gothic Medium',
                                                'Arial Narrow', Arial, sans-serif;
                                                font-weight:800;"
                                         @onclick="@(() => GoToBlog(blog.Slug))"
                                         Class="mt-3">
                                    @blog.Title
                                </MudText>

                                <MudText Typo="Typo.body1"
                                         Truncate="true"
                                         style="color:#757575">
                                    @((blog.Content?.Length > 150)
                                        ? blog.Content.Substring(3, 100) + "..."
                                        : blog.Content)
                                </MudText>
                            </MudContainer>

                            <!-- ACTIONS -->
                            <MudContainer Style="display:flex;justify-content:start;
                                                 padding-left:10px;width:100%">

                                <MudStack Row="true" Wrap="Wrap.Wrap">

                                    <MudText Typo="Typo.caption"
                                             Style="color:#312121">
                                        @blog.CreatedAt?.Date.ToString("MMM dd")
                                    </MudText>

                                    <MudCheckBox T="bool"
                                                 Value="@likes.Contains(blog.Id)"
                                                 ValueChanged="@(checkedValue =>
                                                 ToggleLike(blog.Id, checkedValue))"
                                                 Color="Color.Secondary"
                                                 Size="Size.Small"
                                                 CheckedIcon="@Icons.Material.Filled.Favorite"
                                                 UncheckedIcon="@Icons.Material.Filled.FavoriteBorder"
                                                 Class="like-button-css ml-3" />

                                    <MudText Typo="Typo.caption"
                                             Style="color:#312121;"
                                             Class="ml-1">
                                        @blog.LikesCount
                                    </MudText>

                                    <MudIconButton Icon="@Icons.Material.Filled.Comment"
                                                   Size="Size.Small"
                                                   @onclick="@(() =>
                                                   GoToBlog(blog.Slug))"
                                                   Class="share-css ml-3" />

                                </MudStack>

                                <MudSpacer />

                                <MudStack Row="true" Wrap="Wrap.Wrap">

                                    <MudCheckBox T="bool"
                                                 Value="@saves.Contains(blog.Id)"
                                                 ValueChanged="@(checkedValue =>
                                                 ToggleSave(blog.Id, checkedValue))"
                                                 Color="Color.Secondary"
                                                 Size="Size.Small"
                                                 CheckedIcon="@Icons.Material.Filled.Bookmark"
                                                 UncheckedIcon="@Icons.Material.Filled.BookmarkBorder"
                                                 Style="padding-top:3px;"
                                                 Class="like-button-css save-css ml-2" />

                                    <MudIconButton Icon="@Icons.Material.Filled.Share"
                                                   Size="Size.Small"
                                                   @onclick="@(() =>
                                                   SharePost(blog))"
                                                   Class="share-css ml-2" />

                                    <MudMenu Icon="@Icons.Material.Filled.MoreHoriz"
                                             Size="Size.Small"
                                             AnchorOrigin="Origin.BottomCenter"
                                             TransformOrigin="Origin.TopCenter"
                                             Class="share-css ml-2">

                                        <MudContainer Style="width:220px;padding:0;">
                                            <MudText Typo="Typo.subtitle2"
                                                     Style="padding:10px;margin-left:6px;">
                                                Not Interested
                                            </MudText>
                                            <MudDivider />
                                            <MudText Typo="Typo.subtitle2"
                                                     Style="padding:10px;margin-left:6px;">
                                                Follow author
                                            </MudText>
                                            <MudDivider />
                                            <MudText Typo="Typo.subtitle2"
                                                     Style="padding:10px;margin-left:6px;">
                                                Mute author
                                            </MudText>
                                            <MudText Typo="Typo.subtitle2"
                                                     Style="padding:10px;margin-left:6px;
                                                            padding-top:0;color:rgb(170,0,0)">
                                                Report story...
                                            </MudText>
                                        </MudContainer>
                                    </MudMenu>

                                </MudStack>

                            </MudContainer>
                        </MudItem>

                        <!-- IMAGE -->
                        @if(!isMobile)
                        {
                            <MudItem xs="12" sm="12" md="4">
                            <MudContainer Style="display:flex;
                                                 justify-content:center;
                                                 align-items:center;
                                                 width:100%;height:100%;
                                                 padding:0;cursor:pointer;"
                                          @onclick="@(() => GoToBlog(blog.Slug))">

                                <MudImage Src="@blog.CoverImageUrl"
                                          Alt="@blog.Title"
                                          Style="@ImageStyle" />
                            </MudContainer>
                        </MudItem>
                        }

                    </MudGrid>
                </MudContainer>

                <MudDivider />
            }
        }
    }
</MudContainer>

@code {

    [Parameter]
    public string Title { get; set; }

    private List<BlogDto>? blogs;
    private List<int> likes = new();
    private List<int> saves = new();
    private bool isMobile;

    Breakpoint currentBp;

    void OnBreakpointChanged(Breakpoint bp)
    {
        currentBp = bp;
        isMobile = bp <= Breakpoint.Sm;
        StateHasChanged();
    }

    string ContainerStyle =>
        currentBp <= Breakpoint.Sm
        ? "height:90vh;overflow-y:auto;padding-left:10px;padding-right:10px;"
        : currentBp == Breakpoint.Md
        ? "height:90vh;overflow-y:auto;padding-left:60px;padding-right:60px;"
        : "height:90vh;overflow-y:auto;padding-left:150px;padding-right:150px;";

    string ImageStyle =>
        currentBp <= Breakpoint.Sm
        ? "width:100%;height:auto;padding:10px;"
        : "width:100%;height:100%;padding-top:50px;padding-bottom:40px;padding-right:20px;";

    protected override async Task OnInitializedAsync()
    {
        blogs = await BSService.GetAllBlogsAsync();
        likes = await BSService.GetLikedIdAsync();
        saves = await BSService.GetSavedIdAsync();
    }

    private void GoToBlog(string slug)
    {
        NavigationManager.NavigateTo($"/blog/{slug}");
    }

    private async Task ToggleLike(int blogId, bool isChecked)
    {
        if (isChecked)
        {
            if (!likes.Contains(blogId))
            {
                likes.Add(blogId);
                blogs.First(b => b.Id == blogId).LikesCount++;
                await BSService.ToggleLikeAsync(blogId, true);
            }
        }
        else
        {
            if (likes.Contains(blogId))
            {
                likes.Remove(blogId);
                blogs.First(b => b.Id == blogId).LikesCount--;
                await BSService.ToggleLikeAsync(blogId, false);
            }
        }
    }

    private async Task ToggleSave(int blogId, bool isChecked)
    {
        if (isChecked)
        {
            if (!saves.Contains(blogId))
            {
                saves.Add(blogId);
                await BSService.ToggleSaveAsync(blogId, true);
            }
        }
        else
        {
            if (saves.Contains(blogId))
            {
                saves.Remove(blogId);
                await BSService.ToggleSaveAsync(blogId, false);
            }
        }
    }

    private async Task SharePost(BlogDto blog)
    {
        var title = blog.Title;
        var text = blog?.Content.Substring(0, 50);
        var url = $"https://myblog.com/blog/{blog.Slug}";

        await JS.InvokeVoidAsync("navigator.share", new
        {
            title,
            text,
            url
        });
    }
}

<style>
    .like-button-css .mud-icon-button {
        padding: 0;
    }

    body {
        background: linear-gradient(to bottom, #ffffff, #ede9ff);
        height: 100%;
    }
</style>
